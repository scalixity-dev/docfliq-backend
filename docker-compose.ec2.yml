# EC2 deployment — Microservices with Docker Compose profiles
# Postgres is on AWS RDS (not containerized)
#
# Usage:
#   # All services on one machine:
#   docker compose -f docker-compose.ec2.yml --env-file .env.ec2 --profile identity --profile content --profile redis --profile opensearch --profile nginx up -d --build
#
#   # Only identity + redis on this machine:
#   docker compose -f docker-compose.ec2.yml --env-file .env.ec2 --profile identity --profile redis --profile nginx up -d --build
#
#   # Only content + opensearch + redis on this machine:
#   docker compose -f docker-compose.ec2.yml --env-file .env.ec2 --profile content --profile redis --profile opensearch --profile nginx up -d --build
#
#   # Shorthand — run everything:
#   docker compose -f docker-compose.ec2.yml --env-file .env.ec2 --profile all up -d --build

version: "3.9"

services:
  # ─── Data stores (Redis + OpenSearch — Postgres is on RDS) ─────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    profiles: ["redis", "all"]
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  opensearch:
    image: opensearchproject/opensearch:2.11.0
    restart: unless-stopped
    profiles: ["opensearch", "all"]
    environment:
      - discovery.type=single-node
      - DISABLE_SECURITY_PLUGIN=true
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "127.0.0.1:9200:9200"
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10

  # ─── Application services ──────────────────────────────────────
  identity:
    build:
      context: .
      dockerfile: services/identity/Dockerfile
    restart: unless-stopped
    profiles: ["identity", "all"]
    ports:
      - "${IDENTITY_HOST_PORT:-127.0.0.1:8001}:8000"
    environment:
      IDENTITY_DATABASE_URL: ${IDENTITY_DATABASE_URL:?Set IDENTITY_DATABASE_URL in .env.ec2}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      JWT_SECRET: ${JWT_SECRET:?Set JWT_SECRET in .env.ec2}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-docfliq-identity}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-docfliq-services}
      JWT_EXPIRE_SECONDS: ${JWT_EXPIRE_SECONDS:-900}
      JWT_REFRESH_EXPIRE_SECONDS: ${JWT_REFRESH_EXPIRE_SECONDS:-604800}
      ENV_NAME: ${ENV_NAME:-production}
      CORS_ORIGINS: ${CORS_ORIGINS}
      CONTENT_SERVICE_URL: ${CONTENT_SERVICE_URL:-http://content:8000/api/v1}
      APP_BASE_URL: ${APP_BASE_URL}
      # SMTP
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-25}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-DOCFLIQ}
      SMTP_START_TLS: ${SMTP_START_TLS:-true}
      # Brevo
      BREVO_API_KEY: ${BREVO_API_KEY:-}
      BREVO_FROM_EMAIL: ${BREVO_FROM_EMAIL:-noreply@docfliq.com}
      BREVO_FROM_NAME: ${BREVO_FROM_NAME:-DOCFLIQ}
      # Twilio
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_VERIFY_SERVICE_SID: ${TWILIO_VERIFY_SERVICE_SID:-}
      # OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      # AWS / S3
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-ap-south-1}
      S3_BUCKET: ${S3_BUCKET:-docfliq-user-content-prod}

  content:
    build:
      context: .
      dockerfile: services/content/Dockerfile
    restart: unless-stopped
    profiles: ["content", "all"]
    ports:
      - "${CONTENT_HOST_PORT:-127.0.0.1:8002}:8000"
    environment:
      CONTENT_DATABASE_URL: ${CONTENT_DATABASE_URL:?Set CONTENT_DATABASE_URL in .env.ec2}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      JWT_ISSUER: ${JWT_ISSUER:-docfliq-identity}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-docfliq-services}
      ENV_NAME: ${ENV_NAME:-production}
      CORS_ORIGINS: ${CORS_ORIGINS}
      IDENTITY_SERVICE_URL: ${IDENTITY_SERVICE_URL:-http://identity:8000/api/v1}
      # OpenSearch
      OPENSEARCH_URL: ${OPENSEARCH_URL:-http://opensearch:9200}
      OPENSEARCH_ENABLED: ${OPENSEARCH_ENABLED:-true}
      OPENSEARCH_INDEX_PREFIX: ${OPENSEARCH_INDEX_PREFIX:-docfliq}
      OPENSEARCH_AUTH_MODE: basic

  # ─── Reverse proxy + SSL termination ───────────────────────────
  nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    profiles: ["nginx", "all"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.ec2.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot_conf:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro

  certbot:
    image: certbot/certbot
    restart: unless-stopped
    profiles: ["nginx", "all"]
    volumes:
      - certbot_conf:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  redis_data:
  opensearch_data:
  certbot_conf:
  certbot_www:
